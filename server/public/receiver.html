<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebRTC Screen Share - Receiver</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }

        #startBtn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #startBtn:hover {
            background: #45a049;
        }

        #remoteVideo {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
        }

        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected { background: #4CAF50; }
        .status-disconnected { background: #f44336; }

        #mouseIndicator {
            position: fixed;
            width: 20px;
            height: 20px;
            background: rgba(255, 0, 0, 0.7);
            border: 2px solid #fff;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
            display: none;
        }
    </style>
</head>
<body>
<!-- ç”¨æˆ·å¿…é¡»å…ˆç‚¹å‡»è¿™ä¸ªæŒ‰é’® -->
<button id="startBtn">ğŸŸ¢ ç‚¹å‡»å…è®¸æ¥æ”¶è§†é¢‘ï¼ˆå¿…é¡»å…ˆç‚¹æˆ‘ï¼‰</button>

<!-- æ§åˆ¶é¢æ¿ -->
<div id="controls">
    <div>
        <span class="status-dot" id="connectionDot"></span>
        è¿æ¥: <span id="connectionStatus">æœªè¿æ¥</span>
    </div>
    <div>
        <span class="status-dot" id="mouseDot"></span>
        é¼ æ ‡æ§åˆ¶: <span id="mouseStatus">æœªæ¿€æ´»</span>
    </div>
    <div>å‘é€äº‹ä»¶: <span id="eventCount">0</span></div>
</div>

<!-- é¼ æ ‡ä½ç½®æŒ‡ç¤ºå™¨ -->
<div id="mouseIndicator"></div>

<video
        id="remoteVideo"
        playsinline
        muted
        style="display: none;">
</video>

<script>
    const ws = new WebSocket("wss://192.168.0.20:443");
    const pc = new RTCPeerConnection();
    const remoteVideo = document.getElementById("remoteVideo");
    const startBtn = document.getElementById("startBtn");
    const controls = document.getElementById("controls");
    const mouseIndicator = document.getElementById("mouseIndicator");

    let streamSet = false;
    let dataChannel = null;
    let mouseControlEnabled = false;
    let eventCount = 0;
    let lastMousePosition = { x: 0, y: 0 };
    let isMouseDown = false;

    // çŠ¶æ€å…ƒç´ 
    const statusElements = {
        connection: document.getElementById('connectionStatus'),
        connectionDot: document.getElementById('connectionDot'),
        mouse: document.getElementById('mouseStatus'),
        mouseDot: document.getElementById('mouseDot'),
        eventCount: document.getElementById('eventCount')
    };

    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(connected) {
        statusElements.connection.textContent = connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
        statusElements.connectionDot.className = `status-dot ${connected ? 'status-connected' : 'status-disconnected'}`;
    }

    // æ›´æ–°é¼ æ ‡æ§åˆ¶çŠ¶æ€
    function updateMouseStatus(enabled) {
        mouseControlEnabled = enabled;
        statusElements.mouse.textContent = enabled ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»';
        statusElements.mouseDot.className = `status-dot ${enabled ? 'status-connected' : 'status-disconnected'}`;
    }

    // æ›´æ–°äº‹ä»¶è®¡æ•°
    function updateEventCount() {
        eventCount++;
        statusElements.eventCount.textContent = eventCount;
    }

    // WebSocket äº‹ä»¶
    ws.onopen = () => {
        console.log('WebSocket è¿æ¥å·²å»ºç«‹');
        updateConnectionStatus(true);
    };

    ws.onclose = () => {
        console.log('WebSocket è¿æ¥å·²æ–­å¼€');
        updateConnectionStatus(false);
        updateMouseStatus(false);
    };

    ws.onerror = (error) => {
        console.error('WebSocket é”™è¯¯:', error);
        updateConnectionStatus(false);
    };

    // æ•°æ®é€šé“äº‹ä»¶å¤„ç†
    pc.ondatachannel = (event) => {
        dataChannel = event.channel;
        console.log('æ¥æ”¶åˆ°æ•°æ®é€šé“:', dataChannel.label);

        dataChannel.onopen = () => {
            console.log('æ•°æ®é€šé“å·²æ‰“å¼€ - é¼ æ ‡æ§åˆ¶æ¿€æ´»');
            updateMouseStatus(true);
        };

        dataChannel.onclose = () => {
            console.log('æ•°æ®é€šé“å·²å…³é—­ - é¼ æ ‡æ§åˆ¶åœç”¨');
            updateMouseStatus(false);
        };

        dataChannel.onerror = (error) => {
            console.error('æ•°æ®é€šé“é”™è¯¯:', error);
            updateMouseStatus(false);
        };
    };

    // å‘é€é¼ æ ‡äº‹ä»¶åˆ°å‘é€ç«¯
    function sendMouseEvent(eventData) {
        if (dataChannel && dataChannel.readyState === 'open' && mouseControlEnabled) {
            try {
                dataChannel.send(JSON.stringify(eventData));
                updateEventCount();
                console.log('å‘é€é¼ æ ‡äº‹ä»¶:', eventData.type, eventData.x, eventData.y);
            } catch (e) {
                console.error('å‘é€é¼ æ ‡äº‹ä»¶å¤±è´¥:', e);
            }
        }
    }

    // è·å–ç›¸å¯¹äºè§†é¢‘çš„åæ ‡
    function getVideoRelativeCoordinates(clientX, clientY) {
        const videoRect = remoteVideo.getBoundingClientRect();
        const videoAspectRatio = remoteVideo.videoWidth / remoteVideo.videoHeight;
        const containerAspectRatio = videoRect.width / videoRect.height;

        let videoDisplayWidth, videoDisplayHeight;
        let offsetX = 0, offsetY = 0;

        if (containerAspectRatio > videoAspectRatio) {
            // å®¹å™¨æ›´å®½ï¼Œè§†é¢‘åœ¨å‚ç›´æ–¹å‘å¡«æ»¡
            videoDisplayHeight = videoRect.height;
            videoDisplayWidth = videoDisplayHeight * videoAspectRatio;
            offsetX = (videoRect.width - videoDisplayWidth) / 2;
        } else {
            // å®¹å™¨æ›´é«˜ï¼Œè§†é¢‘åœ¨æ°´å¹³æ–¹å‘å¡«æ»¡
            videoDisplayWidth = videoRect.width;
            videoDisplayHeight = videoDisplayWidth / videoAspectRatio;
            offsetY = (videoRect.height - videoDisplayHeight) / 2;
        }

        // è®¡ç®—ç›¸å¯¹äºå®é™…è§†é¢‘å†…å®¹çš„åæ ‡
        const relativeX = (clientX - videoRect.left - offsetX) / videoDisplayWidth;
        const relativeY = (clientY - videoRect.top - offsetY) / videoDisplayHeight;

        // è½¬æ¢ä¸ºå‘é€ç«¯å±å¹•åæ ‡ (å‡è®¾å‘é€ç«¯åˆ†è¾¨ç‡)
        const screenX = Math.round(relativeX * (remoteVideo.videoWidth || 1920));
        const screenY = Math.round(relativeY * (remoteVideo.videoHeight || 1080));

        return { x: screenX, y: screenY };
    }

    // æ›´æ–°é¼ æ ‡æŒ‡ç¤ºå™¨ä½ç½®
    function updateMouseIndicator(clientX, clientY) {
        mouseIndicator.style.left = (clientX - 10) + 'px';
        mouseIndicator.style.top = (clientY - 10) + 'px';
        mouseIndicator.style.display = 'block';
    }

    // é¼ æ ‡äº‹ä»¶å¤„ç†
    function setupMouseEvents() {
        // é¼ æ ‡ç§»åŠ¨
        remoteVideo.addEventListener('mousemove', (e) => {
            if (!mouseControlEnabled) return;

            const coords = getVideoRelativeCoordinates(e.clientX, e.clientY);
            lastMousePosition = coords;

            updateMouseIndicator(e.clientX, e.clientY);

            sendMouseEvent({
                type: 'mousemove',
                x: coords.x,
                y: coords.y,
                timestamp: Date.now()
            });
        });

        // é¼ æ ‡æŒ‰ä¸‹
        remoteVideo.addEventListener('mousedown', (e) => {
            if (!mouseControlEnabled) return;
            e.preventDefault();

            isMouseDown = true;
            const coords = getVideoRelativeCoordinates(e.clientX, e.clientY);

            sendMouseEvent({
                type: 'mousedown',
                x: coords.x,
                y: coords.y,
                button: e.button,
                timestamp: Date.now()
            });
        });

        // é¼ æ ‡æ¾å¼€
        remoteVideo.addEventListener('mouseup', (e) => {
            if (!mouseControlEnabled) return;
            e.preventDefault();

            isMouseDown = false;
            const coords = getVideoRelativeCoordinates(e.clientX, e.clientY);

            sendMouseEvent({
                type: 'mouseup',
                x: coords.x,
                y: coords.y,
                button: e.button,
                timestamp: Date.now()
            });
        });

        // é¼ æ ‡ç‚¹å‡»
        remoteVideo.addEventListener('click', (e) => {
            if (!mouseControlEnabled) return;
            e.preventDefault();

            const coords = getVideoRelativeCoordinates(e.clientX, e.clientY);

            sendMouseEvent({
                type: 'click',
                x: coords.x,
                y: coords.y,
                button: e.button,
                timestamp: Date.now()
            });
        });

        // å³é”®èœå•
        remoteVideo.addEventListener('contextmenu', (e) => {
            if (!mouseControlEnabled) return;
            e.preventDefault();

            const coords = getVideoRelativeCoordinates(e.clientX, e.clientY);

            sendMouseEvent({
                type: 'contextmenu',
                x: coords.x,
                y: coords.y,
                timestamp: Date.now()
            });
        });

        // é¼ æ ‡æ»šè½®
        remoteVideo.addEventListener('wheel', (e) => {
            if (!mouseControlEnabled) return;
            e.preventDefault();

            const coords = getVideoRelativeCoordinates(e.clientX, e.clientY);

            sendMouseEvent({
                type: 'wheel',
                x: coords.x,
                y: coords.y,
                deltaX: e.deltaX,
                deltaY: e.deltaY,
                deltaZ: e.deltaZ,
                timestamp: Date.now()
            });
        });

        // åŒå‡»
        remoteVideo.addEventListener('dblclick', (e) => {
            if (!mouseControlEnabled) return;
            e.preventDefault();

            const coords = getVideoRelativeCoordinates(e.clientX, e.clientY);

            sendMouseEvent({
                type: 'dblclick',
                x: coords.x,
                y: coords.y,
                button: e.button,
                timestamp: Date.now()
            });
        });

        // é¼ æ ‡ç¦»å¼€è§†é¢‘åŒºåŸŸ
        remoteVideo.addEventListener('mouseleave', () => {
            mouseIndicator.style.display = 'none';
        });

        // é”®ç›˜äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
        document.addEventListener('keydown', (e) => {
            if (!mouseControlEnabled || document.activeElement !== remoteVideo) return;

            sendMouseEvent({
                type: 'keydown',
                key: e.key,
                code: e.code,
                ctrlKey: e.ctrlKey,
                shiftKey: e.shiftKey,
                altKey: e.altKey,
                metaKey: e.metaKey,
                timestamp: Date.now()
            });
        });

        document.addEventListener('keyup', (e) => {
            if (!mouseControlEnabled || document.activeElement !== remoteVideo) return;

            sendMouseEvent({
                type: 'keyup',
                key: e.key,
                code: e.code,
                ctrlKey: e.ctrlKey,
                shiftKey: e.shiftKey,
                altKey: e.altKey,
                metaKey: e.metaKey,
                timestamp: Date.now()
            });
        });
    }

    // å¼€å§‹æŒ‰é’®ç‚¹å‡»
    startBtn.onclick = () => {
        startBtn.style.display = "none";
        remoteVideo.style.display = "block";
        controls.style.display = "block";

        // è®¾ç½®è§†é¢‘å¯è·å¾—ç„¦ç‚¹ä»¥æ¥æ”¶é”®ç›˜äº‹ä»¶
        remoteVideo.setAttribute('tabindex', '0');
        remoteVideo.focus();

        // å¦‚æœå·²ç»æœ‰æµäº†ï¼Œç«‹å³æ’­æ”¾
        if (streamSet && remoteVideo.srcObject) {
            remoteVideo.play().then(() => {
                console.log("è§†é¢‘æ’­æ”¾æˆåŠŸ");
            }).catch(e => {
                console.error("æ’­æ”¾å¤±è´¥:", e);
            });
        }
    };

    // å½“æ”¶åˆ°è¿œç¨‹æµæ—¶
    pc.ontrack = (event) => {
        const stream = event.streams[0];
        console.log("æ”¶åˆ°è¿œç¨‹æµ:", stream);

        remoteVideo.srcObject = stream;
        streamSet = true;

        // å¦‚æœç”¨æˆ·å·²ç»ç‚¹å‡»è¿‡æŒ‰é’®ï¼Œå¯ä»¥è‡ªåŠ¨æ’­æ”¾
        if (startBtn.style.display === "none") {
            remoteVideo.play().then(() => {
                console.log("è§†é¢‘è‡ªåŠ¨æ’­æ”¾æˆåŠŸ");
            }).catch(e => {
                console.error("è‡ªåŠ¨æ’­æ”¾å¤±è´¥:", e);
            });
        } else {
            console.warn("ç”¨æˆ·è¿˜æ²¡ç‚¹å‡»ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»...");
        }
    };

    // ä¿¡ä»¤é€»è¾‘
    pc.onicecandidate = (event) => {
        if (event.candidate) {
            ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
        }
    };

    ws.onmessage = async (event) => {
        const data = event.data;
        let message;
        try {
            if (typeof data === 'string') {
                message = JSON.parse(data);
            } else if (data instanceof Blob) {
                const text = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result);
                    reader.readAsText(data);
                });
                message = JSON.parse(text);
            } else {
                return;
            }
        } catch (e) {
            console.error("è§£ææ¶ˆæ¯å¤±è´¥:", e);
            return;
        }

        try {
            if (message.type === "offer") {
                await pc.setRemoteDescription(new RTCSessionDescription({
                    type: message.type,
                    sdp: message.sdp
                }));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: "answer", sdp: answer.sdp }));
            } else if (message.type === "candidate") {
                await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
            }
        } catch (e) {
            console.error("å¤„ç†ä¿¡ä»¤å¤±è´¥:", e);
        }
    };

    // åˆå§‹åŒ–é¼ æ ‡äº‹ä»¶
    setupMouseEvents();

    // è¿æ¥çŠ¶æ€ç›‘æ§
    pc.onconnectionstatechange = () => {
        console.log('PeerConnection çŠ¶æ€:', pc.connectionState);
        updateConnectionStatus(pc.connectionState === 'connected');
    };

    pc.oniceconnectionstatechange = () => {
        console.log('ICE è¿æ¥çŠ¶æ€:', pc.iceConnectionState);
    };

</script>
</body>
</html>